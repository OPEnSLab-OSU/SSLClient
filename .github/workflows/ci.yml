name: CI
on: [push, pull_request]

jobs:
  build-examples:
    name: Build Example ${{ matrix.example }} for ${{ matrix.board.fqbn }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        example: 
          - EthernetHTTPS
          - EthernetMultiHTTPS
          - EthernetMQTT
        board:
          # Arduino Zero
          - arduino-platform: arduino:samd
            fqbn: arduino:samd:mzero_bl
          # Adafruit Feather M0
          - arduino-platform: arduino:samd adafruit:samd
            fqbn: adafruit:samd:adafruit_feather_m0
          # Arduino Due
          - arduino-platform: arduino:sam
            fqbn: arduino:sam:arduino_due_x
        include:
          # STM32 Nucleo 144
          - board:
              arduino-platform: STM32:stm32
              fqbn: STM32:stm32:Nucleo_144:pnum=NUCLEO_F767ZI
            example: stm32/EthernetHTTPSstm32
    env:
      ARDUINO_BOARD_MANAGER_ADDITIONAL_URLS: "https://adafruit.github.io/arduino-board-index/package_adafruit_index.json,https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json,https://github.com/stm32duino/BoardManagerFiles/raw/master/STM32/package_stm_index.json"
      DOXYFILE: .travis/Doxyfile
    steps:    
      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v1.1.1
      
      # Install Dependencies
      - name: Install Core(s)
        run: arduino-cli core install ${{ matrix.board.arduino-platform }} -v
      - name: Install EthernetLarge
        run: git clone https://github.com/OPEnSLab-OSU/EthernetLarge.git ~/Arduino/libraries/EthernetLarge
      - name: Install Other Libraries
        run: arduino-cli lib install "STM32duino STM32Ethernet" PubSubClient -v
      
      # Checkout
      - name: Checkout
        uses: actions/checkout@v2
        with:
          path: SSLClient
      
      # TODO: Cache dependencies
      # Compile
      - name: Compile Sketch
        run: arduino-cli compile -v --libraries . --warnings all --fqbn ${{ matrix.board.fqbn }} SSLClient/examples/${{ matrix.example }}
